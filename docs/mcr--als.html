<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Alternating least squares | Getting started with mdatools for R</title>
  <meta name="description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualize results for one method, he or she can easily do this for the others." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Alternating least squares | Getting started with mdatools for R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualize results for one method, he or she can easily do this for the others." />
  <meta name="github-repo" content="svkucheryavski/mdatools.bookdown" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Alternating least squares | Getting started with mdatools for R" />
  
  <meta name="twitter:description" content="This is a user guide for mdatools — R package for preprocessing, exploring and analysis of multivariate data. The package provides methods mostly common for Chemometrics. The general idea of the package is to collect most of the common chemometric methods and give a similar user interface for using them. So if a user knows how to make a model and visualize results for one method, he or she can easily do this for the others." />
  

<meta name="author" content="Sergey Kucheryavskiy" />


<meta name="date" content="2021-09-12" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="mcr--purity.html"/>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="styles.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="news.html"><a href="news.html"><i class="fa fa-check"></i>What is new</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i>Overview</a>
<ul>
<li class="chapter" data-level="" data-path="overview--what-mdatools-can-do.html"><a href="overview--what-mdatools-can-do.html"><i class="fa fa-check"></i>What mdatools can do?</a></li>
<li class="chapter" data-level="" data-path="overview--how-to-install.html"><a href="overview--how-to-install.html"><i class="fa fa-check"></i>How to install</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets.html"><a href="datasets.html"><i class="fa fa-check"></i>Datasets and plots</a>
<ul>
<li class="chapter" data-level="" data-path="datasets--attributes-and-factors.html"><a href="datasets--attributes-and-factors.html"><i class="fa fa-check"></i>Attributes and factors</a>
<ul>
<li class="chapter" data-level="" data-path="datasets--attributes-and-factors.html"><a href="datasets--attributes-and-factors.html#attributes-for-plots"><i class="fa fa-check"></i>Attributes for plots</a></li>
<li class="chapter" data-level="" data-path="datasets--attributes-and-factors.html"><a href="datasets--attributes-and-factors.html#special-methods-for-data-transformations"><i class="fa fa-check"></i>Special methods for data transformations</a></li>
<li class="chapter" data-level="" data-path="datasets--attributes-and-factors.html"><a href="datasets--attributes-and-factors.html#data-frames-with-factors"><i class="fa fa-check"></i>Data frames with factors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets--excluding-rows-and-columns.html"><a href="datasets--excluding-rows-and-columns.html"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
<li class="chapter" data-level="" data-path="datasets--simple-plots.html"><a href="datasets--simple-plots.html"><i class="fa fa-check"></i>Simple plots</a>
<ul>
<li class="chapter" data-level="" data-path="datasets--simple-plots.html"><a href="datasets--simple-plots.html#scatter-plots"><i class="fa fa-check"></i>Scatter plots</a></li>
<li class="chapter" data-level="" data-path="datasets--simple-plots.html"><a href="datasets--simple-plots.html#line-plots"><i class="fa fa-check"></i>Line plots</a></li>
<li class="chapter" data-level="" data-path="datasets--simple-plots.html"><a href="datasets--simple-plots.html#bar-and-errorbar-plots"><i class="fa fa-check"></i>Bar and errorbar plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets--group-plots.html"><a href="datasets--group-plots.html"><i class="fa fa-check"></i>Plots for groups of objects</a>
<ul>
<li class="chapter" data-level="" data-path="datasets--group-plots.html"><a href="datasets--group-plots.html#one-matrix-or-data-frame"><i class="fa fa-check"></i>One matrix or data frame</a></li>
<li class="chapter" data-level="" data-path="datasets--group-plots.html"><a href="datasets--group-plots.html#list-with-matrices-or-data-frames"><i class="fa fa-check"></i>List with matrices or data frames</a></li>
<li class="chapter" data-level="" data-path="datasets--group-plots.html"><a href="datasets--group-plots.html#use-factors-to-split-a-dataset-into-groups"><i class="fa fa-check"></i>Use factors to split a dataset into groups</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="datasets--images.html"><a href="datasets--images.html"><i class="fa fa-check"></i>Working with images</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preprocessing.html"><a href="preprocessing.html"><i class="fa fa-check"></i>Preprocessing</a>
<ul>
<li class="chapter" data-level="" data-path="preprocessing--autoscaling.html"><a href="preprocessing--autoscaling.html"><i class="fa fa-check"></i>Autoscaling</a></li>
<li class="chapter" data-level="" data-path="preprocessing--baseline.html"><a href="preprocessing--baseline.html"><i class="fa fa-check"></i>Correction of spectral baseline</a>
<ul>
<li class="chapter" data-level="" data-path="preprocessing--baseline.html"><a href="preprocessing--baseline.html#baseline-correction-with-asymmetric-least-squares"><i class="fa fa-check"></i>Baseline correction with asymmetric least squares</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="preprocessing--savgol.html"><a href="preprocessing--savgol.html"><i class="fa fa-check"></i>Smoothing and derivatives</a></li>
<li class="chapter" data-level="" data-path="preprocessing--eltransform.html"><a href="preprocessing--eltransform.html"><i class="fa fa-check"></i>Element wise transformations</a></li>
<li class="chapter" data-level="" data-path="preprocessing--varsel.html"><a href="preprocessing--varsel.html"><i class="fa fa-check"></i>Variable selection as preprocessing method</a></li>
<li class="chapter" data-level="" data-path="preprocessing-combine.html"><a href="preprocessing-combine.html"><i class="fa fa-check"></i>Combining methods together</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pca.html"><a href="pca.html"><i class="fa fa-check"></i>Principal component analysis</a>
<ul>
<li class="chapter" data-level="" data-path="pca--models-and-results.html"><a href="pca--models-and-results.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="pca--models-and-results.html"><a href="pca--models-and-results.html#model-calibration"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="pca--models-and-results.html"><a href="pca--models-and-results.html#model-validation"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pca--plots.html"><a href="pca--plots.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="pca--plots.html"><a href="pca--plots.html#support-for-images"><i class="fa fa-check"></i>Support for images</a></li>
<li class="chapter" data-level="" data-path="pca--plots.html"><a href="pca--plots.html#manual-x-values-for-loading-line-plot"><i class="fa fa-check"></i>Manual x-values for loading line plot</a></li>
<li class="chapter" data-level="" data-path="pca--plots.html"><a href="pca--plots.html#excluding-rows-and-columns"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pca--distances-and-limits.html"><a href="pca--distances-and-limits.html"><i class="fa fa-check"></i>Distances and critical limits</a>
<ul>
<li class="chapter" data-level="" data-path="pca--distances-and-limits.html"><a href="pca--distances-and-limits.html#distance-to-model-and-score-distance"><i class="fa fa-check"></i>Distance to model and score distance</a></li>
<li class="chapter" data-level="" data-path="pca--distances-and-limits.html"><a href="pca--distances-and-limits.html#critical-limits"><i class="fa fa-check"></i>Critical limits</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pca--model-complexity.html"><a href="pca--model-complexity.html"><i class="fa fa-check"></i>Model complexity</a></li>
<li class="chapter" data-level="" data-path="pca--randomized-algorithm.html"><a href="pca--randomized-algorithm.html"><i class="fa fa-check"></i>Randomized PCA algorithms</a></li>
<li class="chapter" data-level="" data-path="pca--pcv.html"><a href="pca--pcv.html"><i class="fa fa-check"></i>Procrustes cross-validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls.html"><a href="pls.html"><i class="fa fa-check"></i>Partial least squares regression</a>
<ul>
<li class="chapter" data-level="" data-path="pls--models-and-results.html"><a href="pls--models-and-results.html"><i class="fa fa-check"></i>Models and results</a>
<ul>
<li class="chapter" data-level="" data-path="pls--models-and-results.html"><a href="pls--models-and-results.html#model-calibration-1"><i class="fa fa-check"></i>Model calibration</a></li>
<li class="chapter" data-level="" data-path="pls--models-and-results.html"><a href="pls--models-and-results.html#model-validation-1"><i class="fa fa-check"></i>Model validation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls--plotting-methods.html"><a href="pls--plotting-methods.html"><i class="fa fa-check"></i>Plotting methods</a>
<ul>
<li class="chapter" data-level="" data-path="pls--plotting-methods.html"><a href="pls--plotting-methods.html#excluding-rows-and-columns-1"><i class="fa fa-check"></i>Excluding rows and columns</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls--variable-selection.html"><a href="pls--variable-selection.html"><i class="fa fa-check"></i>Variable selection</a></li>
<li class="chapter" data-level="" data-path="pls--distances-and-outliers.html"><a href="pls--distances-and-outliers.html"><i class="fa fa-check"></i>Distances and outlier detection</a>
<ul>
<li class="chapter" data-level="" data-path="pls--distances-and-outliers.html"><a href="pls--distances-and-outliers.html#distance-plot-for-x-decomposition"><i class="fa fa-check"></i>Distance plot for X-decomposition</a></li>
<li class="chapter" data-level="" data-path="pls--distances-and-outliers.html"><a href="pls--distances-and-outliers.html#distance-plot-for-y-decomposition-and-total-distance"><i class="fa fa-check"></i>Distance plot for Y-decomposition and total distance</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="pls--randomization-test.html"><a href="pls--randomization-test.html"><i class="fa fa-check"></i>Randomization test</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="plsda.html"><a href="plsda.html"><i class="fa fa-check"></i>PLS Discriminant Analysis</a>
<ul>
<li class="chapter" data-level="" data-path="plsda--calibration.html"><a href="plsda--calibration.html"><i class="fa fa-check"></i>Calibration of PLS-DA model</a></li>
<li class="chapter" data-level="" data-path="plsda-classification-plots.html"><a href="plsda-classification-plots.html"><i class="fa fa-check"></i>Classification plots</a></li>
<li class="chapter" data-level="" data-path="plsda--performance-plots.html"><a href="plsda--performance-plots.html"><i class="fa fa-check"></i>Performance plots</a></li>
<li class="chapter" data-level="" data-path="plsda--predictions.html"><a href="plsda--predictions.html"><i class="fa fa-check"></i>Predictions for a new data</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simca.html"><a href="simca.html"><i class="fa fa-check"></i>SIMCA/DD-SIMCA classification</a>
<ul>
<li class="chapter" data-level="" data-path="simca--calibration-and-validation.html"><a href="simca--calibration-and-validation.html"><i class="fa fa-check"></i>Calibration and validation</a>
<ul>
<li class="chapter" data-level="" data-path="simca--calibration-and-validation.html"><a href="simca--calibration-and-validation.html#cross-validation"><i class="fa fa-check"></i>Cross-validation</a></li>
<li class="chapter" data-level="" data-path="simca--calibration-and-validation.html"><a href="simca--calibration-and-validation.html#predictions-and-validation-with-a-test-set"><i class="fa fa-check"></i>Predictions and validation with a test set</a></li>
<li class="chapter" data-level="" data-path="simca--calibration-and-validation.html"><a href="simca--calibration-and-validation.html#class-belonging-probabilities"><i class="fa fa-check"></i>Class belonging probabilities</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="simca--multiclass-classification.html"><a href="simca--multiclass-classification.html"><i class="fa fa-check"></i>Multiclass classification</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="ipls.html"><a href="ipls.html"><i class="fa fa-check"></i>Interval PLS</a>
<ul>
<li class="chapter" data-level="" data-path="ipls.html"><a href="ipls.html#forward-ipls"><i class="fa fa-check"></i>Forward iPLS</a></li>
<li class="chapter" data-level="" data-path="ipls.html"><a href="ipls.html#using-test-set-for-validation"><i class="fa fa-check"></i>Using test set for validation</a></li>
<li class="chapter" data-level="" data-path="ipls.html"><a href="ipls.html#backward-ipls"><i class="fa fa-check"></i>Backward iPLS</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mcr.html"><a href="mcr.html"><i class="fa fa-check"></i>Multivariate Curve Resolution</a>
<ul>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html"><i class="fa fa-check"></i>Purity based</a>
<ul>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html#an-example"><i class="fa fa-check"></i>An example</a></li>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html#purity-values-and-spectra"><i class="fa fa-check"></i>Purity values and spectra</a></li>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html#predictions"><i class="fa fa-check"></i>Predictions</a></li>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html#tuning-the-offset-parameter"><i class="fa fa-check"></i>Tuning the offset parameter</a></li>
<li class="chapter" data-level="" data-path="mcr--purity.html"><a href="mcr--purity.html#providing-indices-of-pure-variables"><i class="fa fa-check"></i>Providing indices of pure variables</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html"><i class="fa fa-check"></i>Alternating least squares</a>
<ul>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html#non-negativity"><i class="fa fa-check"></i>Non-negativity</a></li>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html#constraints"><i class="fa fa-check"></i>Constraints</a></li>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html#initial-estimates"><i class="fa fa-check"></i>Initial estimates</a></li>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html#forcing-contribution-and-spectral-values"><i class="fa fa-check"></i>Forcing contribution and spectral values</a></li>
<li class="chapter" data-level="" data-path="mcr--als.html"><a href="mcr--als.html#overview-of-resolving-process-and-results"><i class="fa fa-check"></i>Overview of resolving process and results</a></li>
</ul></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Getting started with mdatools for R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="mcr--als" class="section level2 unnumbered">
<h2>Alternating least squares</h2>
<p>The alternating least squares allows to get <span class="math inline">\(\mathbf{\hat{C}}\)</span> and <span class="math inline">\(\mathbf{\hat{S}}\)</span> by using iterative algorithm, when the ordinary least squares is applied consequently, first to resolve the concentrations by knowing spectra and then to resolve the spectra by using the resolved concentrations:</p>
<p><span class="math display">\[\mathbf{\hat{C}} = \mathbf{D} \mathbf{\hat{S}} (\mathbf{\hat{S}}^T \mathbf{\hat{S}})^{-1}\]</span>
<span class="math display">\[\mathbf{\hat{S}} = \mathbf{D}^T \mathbf{\hat{C}} (\mathbf{\hat{C}}^T \mathbf{\hat{C}})^{-1}\]</span></p>
<p>These two steps continue until a convergence criteria is met. Apparently, there are several issues with the algorithm, that have to be clarified. First of all, to run the first iteration we need to have values for the matrix <span class="math inline">\(\mathbf{\hat{S}}\)</span>. This is what is called <em>initial estimates</em>. In <em>mdatools</em> the initial estimates for the pure component spectra generated automatically as a matrix with random values taken from uniform distribution (between 0 and 1). Apparently the matrix <span class="math inline">\((\mathbf{\hat{S}}^T \mathbf{\hat{S}})\)</span> should not be singular and using random values will ensure this.</p>
<p>On the other hand, using random values does not always provide reproducible results, so some alternatives can be considered. Therefore user can provide any pre-computed values for <span class="math inline">\(\mathbf{\hat{S}}\)</span> using parameter <code>spec.ini</code> as it will also shown below.</p>
<p>The second issue is that using ordinary least squares (OLS) method for the iterations will result in a solution with negative values, which is not physically meaningful. To tackle this problem we either need to constrain the solution, for example by setting all negative values to zero, after each iteration, or by using non-negative least squares for solving the equations. In <em>mdatools</em> both options are available.</p>
<p>Finally, as we mentioned before, curve resolution problem does not have a unique solution. To narrow the range of feasible solutions down, and also to move them towards the right one, we can apply different constraints. Some of the constraints are implemented and available for user, some will be implemented later. However, user can easily provide a manual constraint function as it will be shown below.</p>
<p>We will take all these issues gradually and let’s start with non-negativity and constraints.</p>
<div id="non-negativity" class="section level3 unnumbered">
<h3>Non-negativity</h3>
<p>To tackle the non-negativity problem, in <em>mdatools</em> you can chose one of the following options:</p>
<ol style="list-style-type: decimal">
<li>Use standard OLS solver and apply non-negativity constraint by setting all negative values to zero.</li>
<li>Use non-negative least squares solver (NNLS), e.g. <a href="https://epubs.siam.org/doi/book/10.1137/1.9781611971217">proposed</a> by Lawsen and Hanson.</li>
<li>Use its faster version — Fast Combinatorial NNLS (FC-NNLS) <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/cem.889">proposed</a> by Benthem and Keenan.</li>
<li>Use your own solver</li>
</ol>
<p>The default option is nr. 3 and this is what we would recommend to use. It gives a solution identical to nr. 2 however is much faster in case of multivariate data. You can also provide a function, which implements your own solver. The solver can be changed both for spectra and for contributions, you can even use different solvers for each. The code below shows how to apply MCR-ALS using OLS and FC-NNLS solvers without any constraints.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="mcr--als.html#cb294-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(carbs)</span>
<span id="cb294-2"><a href="mcr--als.html#cb294-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-3"><a href="mcr--als.html#cb294-3" aria-hidden="true" tabindex="-1"></a><span class="co"># apply MCR-ALS with default solver (FC-NNLS)</span></span>
<span id="cb294-4"><a href="mcr--als.html#cb294-4" aria-hidden="true" tabindex="-1"></a>m1 <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>)</span>
<span id="cb294-5"><a href="mcr--als.html#cb294-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-6"><a href="mcr--als.html#cb294-6" aria-hidden="true" tabindex="-1"></a><span class="co"># apply MCR-ALS with OLS solver</span></span>
<span id="cb294-7"><a href="mcr--als.html#cb294-7" aria-hidden="true" tabindex="-1"></a>m2 <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">spec.solver =</span> mcrals.ols, <span class="at">cont.solver =</span> mcrals.ols)</span>
<span id="cb294-8"><a href="mcr--als.html#cb294-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb294-9"><a href="mcr--als.html#cb294-9" aria-hidden="true" tabindex="-1"></a><span class="co"># show the resolved spectra</span></span>
<span id="cb294-10"><a href="mcr--als.html#cb294-10" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb294-11"><a href="mcr--als.html#cb294-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(m1, <span class="at">main =</span> <span class="st">&quot;FC-NNLS solution&quot;</span>)</span>
<span id="cb294-12"><a href="mcr--als.html#cb294-12" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(m2, <span class="at">main =</span> <span class="st">&quot;OLS solution&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-191-1.png" width="864" /></p>
<p>As you can see, the OLS solution without non-negativity constraint contains negative values. Once again, if you do not experiment with negative values, using the default option (FCNNLS) will be the best.</p>
</div>
<div id="constraints" class="section level3 unnumbered">
<h3>Constraints</h3>
<p>Constraints are small functions that can be applied separately to current estimates of spectra or contributions on every step of the algorithm in order to improve the solution. A constraint function takes the matrix with spectra or contributions as an input, does something with the values and returns the matrix of the same size as an output. For example, the simplest constraint is non-negativity, which sets all negative values in the matrix to zeros.</p>
<p>In <em>mdatools</em> constraints can be combined together using lists. Spectra and contributions should have separate sets of constrains. In the example below we show how to use some of the built in constraints:</p>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="mcr--als.html#cb295-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define constraints for contributions</span></span>
<span id="cb295-2"><a href="mcr--als.html#cb295-2" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb295-3"><a href="mcr--als.html#cb295-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;sum&quot;</span>))</span>
<span id="cb295-4"><a href="mcr--als.html#cb295-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb295-5"><a href="mcr--als.html#cb295-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-6"><a href="mcr--als.html#cb295-6" aria-hidden="true" tabindex="-1"></a><span class="co"># define constraints for spectra</span></span>
<span id="cb295-7"><a href="mcr--als.html#cb295-7" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb295-8"><a href="mcr--als.html#cb295-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;angle&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">weight =</span> <span class="fl">0.05</span>)),</span>
<span id="cb295-9"><a href="mcr--als.html#cb295-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;length&quot;</span>))</span>
<span id="cb295-10"><a href="mcr--als.html#cb295-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb295-11"><a href="mcr--als.html#cb295-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-12"><a href="mcr--als.html#cb295-12" aria-hidden="true" tabindex="-1"></a><span class="co"># run MCR-ALS with the constraints</span></span>
<span id="cb295-13"><a href="mcr--als.html#cb295-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb295-14"><a href="mcr--als.html#cb295-14" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">spec.constraints =</span> sc, <span class="at">cont.constraints =</span> cc)</span>
<span id="cb295-15"><a href="mcr--als.html#cb295-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-16"><a href="mcr--als.html#cb295-16" aria-hidden="true" tabindex="-1"></a><span class="co"># normalzie the original spectra to unit length</span></span>
<span id="cb295-17"><a href="mcr--als.html#cb295-17" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="fu">prep.norm</span>(<span class="fu">mda.t</span>(carbs<span class="sc">$</span>S), <span class="st">&quot;length&quot;</span>)</span>
<span id="cb295-18"><a href="mcr--als.html#cb295-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-19"><a href="mcr--als.html#cb295-19" aria-hidden="true" tabindex="-1"></a><span class="co"># get resolved spectra and transpose them</span></span>
<span id="cb295-20"><a href="mcr--als.html#cb295-20" aria-hidden="true" tabindex="-1"></a>S.hat <span class="ot">=</span> <span class="fu">mda.t</span>(m<span class="sc">$</span>resspec)</span>
<span id="cb295-21"><a href="mcr--als.html#cb295-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-22"><a href="mcr--als.html#cb295-22" aria-hidden="true" tabindex="-1"></a><span class="co"># define color and line width for the spectral curves</span></span>
<span id="cb295-23"><a href="mcr--als.html#cb295-23" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;black&quot;</span>)</span>
<span id="cb295-24"><a href="mcr--als.html#cb295-24" aria-hidden="true" tabindex="-1"></a>lwd <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb295-25"><a href="mcr--als.html#cb295-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb295-26"><a href="mcr--als.html#cb295-26" aria-hidden="true" tabindex="-1"></a><span class="co"># show the plots separately for each component and each result object</span></span>
<span id="cb295-27"><a href="mcr--als.html#cb295-27" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb295-28"><a href="mcr--als.html#cb295-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb295-29"><a href="mcr--als.html#cb295-29" aria-hidden="true" tabindex="-1"></a>   s <span class="ot">=</span> <span class="fu">mda.subset</span>(S, a)</span>
<span id="cb295-30"><a href="mcr--als.html#cb295-30" aria-hidden="true" tabindex="-1"></a>   s.hat <span class="ot">=</span> <span class="fu">mda.subset</span>(S.hat, a)</span>
<span id="cb295-31"><a href="mcr--als.html#cb295-31" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mdaplotg</span>(<span class="fu">list</span>(<span class="at">orig =</span> s, <span class="at">resolved =</span> s.hat), <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">col =</span> col, <span class="at">lwd =</span> lwd)</span>
<span id="cb295-32"><a href="mcr--als.html#cb295-32" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-192-1.png" width="864" /></p>
<p>As you can see, we use one constraint to normalize the contributions, so they sum up to one on every step. And we use two constraints for the spectra — first angle constraint, which makes spectra less contrast and increases contrast among the resolved concentration profiles. Then we normalize the spectra to the unit length. The constraints are applied to the spectra or contributions on every iteration and in the same order as they are defined in the list.</p>
<p>You may have noticed the following instruction: <code>set.seed(6)</code> in the code block above. This is needed to make results more reproducible. Since the initial estimates for the resolved spectra are obtained using random number generator, the final result can be different from run to run. To avoid this we seed the generator with number 6, so the final result will be the same regardless how many times we run this code.</p>
<p>The list of available constraints and their parameters can be shown by running <code>constraints.list()</code>:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="mcr--als.html#cb296-1" aria-hidden="true" tabindex="-1"></a><span class="fu">constraints.list</span>()</span></code></pre></div>
<pre><code>## 
## List of constraints available for mcrals():
## 
## 
##  Non-negativity (sets negative values to zero)
##  ---------------
##  name: &#39;nonneg&#39;
##  no parameters required
## 
## 
##  Unimodality (forces contribution or spectral profile to have a single maximum)
##  ---------------
##  name: &#39;unimod&#39;
##  parameters:
##   &#39;tol&#39;: tolerance (between 0 and 1)
## 
## 
##  Closure (forces contributions or spectral profiles sum up to constant value)
##  ---------------
##  name: &#39;closure&#39;
##  parameters:
##   &#39;sum&#39;: value, the data rows should sum up to
## 
## 
##  Normalization (normalize spectra or contributions)
##  ---------------
##  name: &#39;norm&#39;
##  parameters:
##   &#39;type&#39;: type of normalization: &#39;length&#39;, &#39;area&#39; or &#39;sum&#39;
## 
## 
##  Angle (increases contrast among resolved spectra or contributions)
##  ---------------
##  name: &#39;angle&#39;
##  parameters:
##   &#39;weight&#39;: how much of mean will be added: between 0 and 1</code></pre>
<p>In the next few subsections you will find a short description of the currently implemented constraints with some illustrations, as well as instructions how to make a user defined constraint.</p>
<div id="non-negativity-constraint" class="section level4 unnumbered">
<h4>Non-negativity constraint</h4>
<p>The non-negativity constraint simply takes a signal (spectra or contributions for a particular component) and set all negative values to zeros. A plot below demonstrates how the constraint works, the gray line represents the original signal, the blue — signal after applying the constraint.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-194-1.png" width="864" /></p>
<p>It does not have any parameters, so to add the constraint to the list simply use <code>constraint("nonneg")</code>, e.g.:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="mcr--als.html#cb298-1" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb298-2"><a href="mcr--als.html#cb298-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;nonneg&quot;</span>)</span>
<span id="cb298-3"><a href="mcr--als.html#cb298-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="unimodality-constraint" class="section level4 unnumbered">
<h4>Unimodality constraint</h4>
<p>The unimodality constraint is used to force signals having only one peak (maximum). This can be particularly useful for constraining contribution profiles, e.g. when spectra came from a reaction and it is appriory known that concentration developing of components has one peak.</p>
<p>The constraint works as follows. First it finds a global maximum in the signal. Then it goes along each side from the peak and checks if intensity of next point in the signal does not exceed the value of the previous one. If it does, constraint will replace the current value by the previous one.</p>
<p>It is also possible to define a tolerance — value between 0 and 1, which allows taking into account small fluctuation of the intensity due to e.g. noise. Thus if tolerance is 0.05, then only when intensity of current point exceeds the intensity of the previous point by more than 5% it will trigger the constraint.</p>
<p>The figure below shows how the constraint works using three signals — one with small extra peak on the left, one with small extra peak on the right and one unimodal signal. A small amount of noise was added to all signals. There are one original signal (gray) and two constrained signals on the plot. The red one shows the result for 0% tolerance and the blue one shows the result for 20% tolerance.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-196-1.png" width="864" /></p>
<p>As we can see, because of the noise, the constrained profiles have negative values. In this case it makes sense to combine the unimodality and non-negativity constrains. The result of this combination is shown below.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-197-1.png" width="864" />
In order to add the constraint use <code>constraint("unimod")</code> for zero tolerance or <code>constraint("unimod", params = list(tol = 0.05))</code> for 5% tolerance. In the code chunck below you see how to create a set of unimodality and non-negativity constrains e.g. for contribution profiles</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="mcr--als.html#cb299-1" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb299-2"><a href="mcr--als.html#cb299-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;unimod&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">tol =</span> <span class="fl">0.05</span>)),</span>
<span id="cb299-3"><a href="mcr--als.html#cb299-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;nonneg&quot;</span>)</span>
<span id="cb299-4"><a href="mcr--als.html#cb299-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="closure-constraint" class="section level4 unnumbered">
<h4>Closure constraint</h4>
<p>Closure constraint, like unimodality, is mostly applicable to the contribution profiles and aims at preserve the mass balance — so sum of the concetrations of pure components is constant. From that point of view the closure constraint can be thought of normalization made along the observations (or wavelength/wavenumbers in case of spectra) instead of along the components.</p>
<p>The figure below shows how it works using contribution profiles of three components. The colored lines show the profiles and the black dashed line shows the sum of contributions for a given measurements.</p>
<p><img src="_main_files/figure-html/unnamed-chunk-199-1.png" width="864" /></p>
<p>The top plot shows the original profiles. The middle plot shows the constrained profiles, where the closure constrained which limits sum of the contributions to one was applied. The bottom plot shows results for the constrains limited the sum to 10.</p>
<p>As you can see in the last two plots, the dashed line show the constant desired value for all measurements. In order to add the constraint use <code>constraint("closure")</code> for unit sum or <code>constraint("closure", params = list(sum = 10))</code> for e.g. 10.</p>
</div>
<div id="normalization-constraint" class="section level4 unnumbered">
<h4>Normalization constraint</h4>
<p>Normalization costraint aims at making spectra or contribution profiles of invididual components normalized. The normalization can be made by unit length, area or sum. For example, in case of sum normalization, sum of all values of each spectrum or contribution profile will be equal to one.</p>
<p>An example below shows two original signals and the result of normalization of the signals to the unit area (so area under each curve is equal to one).</p>
<p><img src="_main_files/figure-html/unnamed-chunk-200-1.png" width="864" /></p>
<p>The constrain can be added using <code>constraint("closure", params = list(type = "area"))</code>. The value for parameter <code>type</code> can be <code>"area"</code>, <code>"length"</code>, or <code>"sum"</code></p>
</div>
<div id="angle-constraint" class="section level4 unnumbered">
<h4>Angle constraint</h4>
<p>Angle constraint allows to change a contrast among the contribution profiles or resolved spectra. The idea was proposed by Windig <em>at al</em> and all details can be found in <a href="https://www.sciencedirect.com/science/article/pii/S0169743912000378">this paper</a>.</p>
<p>The constraint works as follows. First, mean spectrum or mean contribution profile are computed using the original data, <span class="math inline">\(\mathbf{D}\)</span>. Then, on every iteration, a portion of the mean signal (e.g. 5%) is added, for example, to the resolved contributions. This will lead to smaller contrast among the contribution profiles but, at the same time, will increase the contrast for the resolved spectra. And vice versa, to increase the contrast among the resolved contribution profiles, the constraint should be applied to the spectra.</p>
<p>The constraint can be added using <code>constraint("angle")</code>. By default the portion of mean to be added to the signals is 5% (0.05). To change this value to, e.g. 10%, use <code>constraint("angle", params = list(weight = 0.10))</code>.</p>
</div>
<div id="user-defined-constraints" class="section level4 unnumbered">
<h4>User defined constraints</h4>
<p>We plan to implement more constraints gradually. However you do not need to wait and can use your own constraints, if necessary. This section shows how to do it step by step and how to combine user defined constraint with the implemented ones.</p>
<p>Let’s say, we want to add a random noise to our resolved spectra on each iteration (sounds very stupid, but let’s use it just for fun in this example). So, first we need to create the constraint function. It should have two mandatory arguments: <code>x</code> which will take a current estimates of spectra or contributions and <code>d</code> which is original data used for resolving. There can be any number of optional arguments, in our case we will use argument <code>noise.level</code> which will define a level of noise in percent of maximum value in <code>x</code>:</p>
<p>Here is the function:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="mcr--als.html#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="co"># constraint function which adds random noise from normal distribution</span></span>
<span id="cb300-2"><a href="mcr--als.html#cb300-2" aria-hidden="true" tabindex="-1"></a>myConstraintFunction <span class="ot">&lt;-</span> <span class="cf">function</span>(x, d, <span class="at">noise.level =</span> <span class="fl">0.01</span>) {</span>
<span id="cb300-3"><a href="mcr--als.html#cb300-3" aria-hidden="true" tabindex="-1"></a>   nr <span class="ot">&lt;-</span> <span class="fu">nrow</span>(x)</span>
<span id="cb300-4"><a href="mcr--als.html#cb300-4" aria-hidden="true" tabindex="-1"></a>   nc <span class="ot">&lt;-</span> <span class="fu">ncol</span>(x)</span>
<span id="cb300-5"><a href="mcr--als.html#cb300-5" aria-hidden="true" tabindex="-1"></a>   noise <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(nr <span class="sc">*</span> nc, <span class="at">mean =</span> <span class="dv">0</span>, <span class="at">sd =</span> <span class="fu">max</span>(x) <span class="sc">*</span> noise.level)</span>
<span id="cb300-6"><a href="mcr--als.html#cb300-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb300-7"><a href="mcr--als.html#cb300-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">return</span>(x <span class="sc">+</span> <span class="fu">matrix</span>(noise, nr, nc))</span>
<span id="cb300-8"><a href="mcr--als.html#cb300-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>As you can see we use normal distribution for generating the noise, with zero mean and standard deviation equal to the 1% of maximum value by default. Load this function to the global environment by running this code.</p>
<p>Next we need to create a constraint object, which will use this function, and set the required level of noise, like it is shown here (we take 2% instead of the default value of 1%):</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="mcr--als.html#cb301-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a constraint with noise level of 2%</span></span>
<span id="cb301-2"><a href="mcr--als.html#cb301-2" aria-hidden="true" tabindex="-1"></a>myConstraint <span class="ot">=</span> <span class="fu">list</span>(<span class="at">method =</span> myConstraintFunction, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">noise.level =</span> <span class="fl">0.02</span>))</span>
<span id="cb301-3"><a href="mcr--als.html#cb301-3" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(myConstraint) <span class="ot">=</span> <span class="st">&quot;constraint&quot;</span></span></code></pre></div>
<p>Next we need to define sets of constraints for contributions and for spectra by using lists, like we did for built in constraints, and add our manual constraint object to the list:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="mcr--als.html#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="co"># constraints for contributions</span></span>
<span id="cb302-2"><a href="mcr--als.html#cb302-2" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb302-3"><a href="mcr--als.html#cb302-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;sum&quot;</span>))</span>
<span id="cb302-4"><a href="mcr--als.html#cb302-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb302-5"><a href="mcr--als.html#cb302-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb302-6"><a href="mcr--als.html#cb302-6" aria-hidden="true" tabindex="-1"></a><span class="co"># constraints for spectra</span></span>
<span id="cb302-7"><a href="mcr--als.html#cb302-7" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb302-8"><a href="mcr--als.html#cb302-8" aria-hidden="true" tabindex="-1"></a>   myConstraint,</span>
<span id="cb302-9"><a href="mcr--als.html#cb302-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;length&quot;</span>))</span>
<span id="cb302-10"><a href="mcr--als.html#cb302-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Finally, we just run the MCR-ALS algorithm and check the results. I will again seed the random number generator to make results reproducible.</p>
<div class="sourceCode" id="cb303"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb303-1"><a href="mcr--als.html#cb303-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run mcrals</span></span>
<span id="cb303-2"><a href="mcr--als.html#cb303-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb303-3"><a href="mcr--als.html#cb303-3" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">cont.constraints =</span> cc, <span class="at">spec.constraints =</span> sc)</span>
<span id="cb303-4"><a href="mcr--als.html#cb303-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-5"><a href="mcr--als.html#cb303-5" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize the original spectra to unit length</span></span>
<span id="cb303-6"><a href="mcr--als.html#cb303-6" aria-hidden="true" tabindex="-1"></a>S <span class="ot">=</span> <span class="fu">prep.norm</span>(<span class="fu">mda.t</span>(carbs<span class="sc">$</span>S), <span class="st">&quot;length&quot;</span>)</span>
<span id="cb303-7"><a href="mcr--als.html#cb303-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-8"><a href="mcr--als.html#cb303-8" aria-hidden="true" tabindex="-1"></a><span class="co"># get the resolved spectra and transpose them</span></span>
<span id="cb303-9"><a href="mcr--als.html#cb303-9" aria-hidden="true" tabindex="-1"></a>S.hat <span class="ot">=</span> <span class="fu">mda.t</span>(m<span class="sc">$</span>resspec)</span>
<span id="cb303-10"><a href="mcr--als.html#cb303-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-11"><a href="mcr--als.html#cb303-11" aria-hidden="true" tabindex="-1"></a><span class="co"># define color and line width for the spectral curves</span></span>
<span id="cb303-12"><a href="mcr--als.html#cb303-12" aria-hidden="true" tabindex="-1"></a>col <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;black&quot;</span>)</span>
<span id="cb303-13"><a href="mcr--als.html#cb303-13" aria-hidden="true" tabindex="-1"></a>lwd <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb303-14"><a href="mcr--als.html#cb303-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb303-15"><a href="mcr--als.html#cb303-15" aria-hidden="true" tabindex="-1"></a><span class="co"># show the plots separately for each component and each result object</span></span>
<span id="cb303-16"><a href="mcr--als.html#cb303-16" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">1</span>))</span>
<span id="cb303-17"><a href="mcr--als.html#cb303-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (a <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) {</span>
<span id="cb303-18"><a href="mcr--als.html#cb303-18" aria-hidden="true" tabindex="-1"></a>   s <span class="ot">=</span> <span class="fu">mda.subset</span>(S, a)</span>
<span id="cb303-19"><a href="mcr--als.html#cb303-19" aria-hidden="true" tabindex="-1"></a>   s.hat <span class="ot">=</span> <span class="fu">mda.subset</span>(S.hat, a)</span>
<span id="cb303-20"><a href="mcr--als.html#cb303-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">mdaplotg</span>(<span class="fu">list</span>(<span class="at">orig =</span> s, <span class="at">resolved =</span> s.hat), <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">col =</span> col, <span class="at">lwd =</span> lwd)</span>
<span id="cb303-21"><a href="mcr--als.html#cb303-21" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-204-1.png" width="864" /></p>
<p>As you can see, even with this rather strange constraint the method works, although the resolved spectra are quite noisy. The presence of negative values in the resolved spectra is because we use normal distribution and the constraint is applied after the solver, which provides non-negative solution.</p>
</div>
</div>
<div id="initial-estimates" class="section level3 unnumbered">
<h3>Initial estimates</h3>
<p>As it was mentioned above, one can provide any initial estimates for the spectra as a matrix with size <span class="math inline">\(J \times A\)</span>, where <span class="math inline">\(A\)</span> is the number of components and <span class="math inline">\(J\)</span> is number of variables (columns) in the original data. However, the matrix with provided values should not be singular, otherwise the algorithm will fail.</p>
<p>In the example below we provide absolute values of PCA loadings as the initial estimates. No constraints are provided in this case for the sake of simplicity.</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="mcr--als.html#cb304-1" aria-hidden="true" tabindex="-1"></a>m.pca <span class="ot">=</span> <span class="fu">pca</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">center =</span> <span class="cn">FALSE</span>)</span>
<span id="cb304-2"><a href="mcr--als.html#cb304-2" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">spec.ini =</span> <span class="fu">abs</span>(m.pca<span class="sc">$</span>loadings))</span>
<span id="cb304-3"><a href="mcr--als.html#cb304-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-4"><a href="mcr--als.html#cb304-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectra</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-205-1.png" width="864" /></p>
</div>
<div id="forcing-contribution-and-spectral-values" class="section level3 unnumbered">
<h3>Forcing contribution and spectral values</h3>
<p>Sometimes we know the exact concentration of components or their absence for given measurements. For example we may know the concentration of ingredients at the beginning of a reaction or measure concentration of reaction products at the end. Same for the spectra, e.g. we know wavenumbers or wavelength where no peaks are expected for a particular component. In order to provide this information we can let <code>mcrals()</code> force these values to be equal to zero. Actually it can be any number, but since the resolved contributions and spectral intensities are relative, you need to be careful with providing the non-zero values.</p>
<p>In order to use this possibility you need to provide values for two parameters: <code>cont.forced</code> for the contributions and <code>spec.forced</code> for the spectra. For example if we resolve spectra and contributions for three component system and we do not expect presence of third component at the beginning of a reaction, we can set the values as follows:</p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="mcr--als.html#cb305-1" aria-hidden="true" tabindex="-1"></a>cont.forced <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(D), ncomp)</span>
<span id="cb305-2"><a href="mcr--als.html#cb305-2" aria-hidden="true" tabindex="-1"></a>cont.forced[<span class="dv">1</span>, <span class="dv">3</span>] <span class="ot">=</span> <span class="dv">0</span></span></code></pre></div>
<p>The first line in this chunk creates a matrix and fill it with missing (<code>NA</code>) values. The matrix has the same dimension as future matrix with resolved contributions — same number of rows as the matrix with mixtures, <code>D</code>, and same number of columns as the expected number of pure components.</p>
<p>After that, we set a value at the first row and the third column to zero. Which means “force concentration of the third component for the first observation to zero”. Inside the ALS loop, on every iteration the <code>mcrals()</code> method will replace the resolved concentration with the provided value.</p>
<p>Here is an example, based on the carbs data we used before. In this case I add the pure spectra on top of the matrix with mixtures. And since these are spectra of pure components, I know that the spectrum for the first observation does not contain any of C2 and C3, the second observation does not contain C1 and C3 and, finally, the third observation does not contain C1 and C2. Here is how to do this:</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="mcr--als.html#cb306-1" aria-hidden="true" tabindex="-1"></a>ncomp <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb306-2"><a href="mcr--als.html#cb306-2" aria-hidden="true" tabindex="-1"></a>Dplus <span class="ot">&lt;-</span> <span class="fu">mda.rbind</span>(<span class="fu">mda.t</span>(carbs<span class="sc">$</span>S), carbs<span class="sc">$</span>D)</span>
<span id="cb306-3"><a href="mcr--als.html#cb306-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-4"><a href="mcr--als.html#cb306-4" aria-hidden="true" tabindex="-1"></a>cont.forced <span class="ot">=</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="fu">nrow</span>(Dplus), ncomp)</span>
<span id="cb306-5"><a href="mcr--als.html#cb306-5" aria-hidden="true" tabindex="-1"></a>cont.forced[<span class="dv">1</span>, ] <span class="ot">=</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="dv">0</span>, <span class="dv">0</span>)</span>
<span id="cb306-6"><a href="mcr--als.html#cb306-6" aria-hidden="true" tabindex="-1"></a>cont.forced[<span class="dv">2</span>, ] <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">NA</span>, <span class="dv">0</span>)</span>
<span id="cb306-7"><a href="mcr--als.html#cb306-7" aria-hidden="true" tabindex="-1"></a>cont.forced[<span class="dv">3</span>, ] <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="cn">NA</span>)</span>
<span id="cb306-8"><a href="mcr--als.html#cb306-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb306-9"><a href="mcr--als.html#cb306-9" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">mcrals</span>(Dplus, <span class="at">ncomp =</span> ncomp, <span class="at">cont.forced =</span> cont.forced)</span></code></pre></div>
<p>Here are the resolved contributions:</p>
<div class="sourceCode" id="cb307"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb307-1"><a href="mcr--als.html#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(<span class="fu">head</span>(m<span class="sc">$</span>rescont))</span></code></pre></div>
<pre><code>##         Comp 1     Comp 2     Comp 3
## [1,] 7.6462723  0.0000000 0.11344608
## [2,] 0.1331184 13.1168977 0.09604429
## [3,] 0.1492307  0.0000000 7.61280985
## [4,] 7.8180191  0.6992354 0.64461538
## [5,] 6.3207464  3.2922424 0.70466107
## [6,] 4.8315353  5.9818678 0.60008529</code></pre>
<p>As one can see, the ones we forced to be zero, are either zeros or just very small numbers. Forcing the spectral values works in a similar way.</p>
</div>
<div id="overview-of-resolving-process-and-results" class="section level3 unnumbered">
<h3>Overview of resolving process and results</h3>
<p>The <code>mcrals()</code> also computes the explained variance, which can be shown using <code>plotVariance()</code> and <code>plotCumVariance()</code> functions. It also has <code>predict()</code> method which works similar to <code>mcrpure</code>. Some examples are shown below:</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="mcr--als.html#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="co"># define constraints for contributions</span></span>
<span id="cb309-2"><a href="mcr--als.html#cb309-2" aria-hidden="true" tabindex="-1"></a>cc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb309-3"><a href="mcr--als.html#cb309-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;sum&quot;</span>))</span>
<span id="cb309-4"><a href="mcr--als.html#cb309-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb309-5"><a href="mcr--als.html#cb309-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-6"><a href="mcr--als.html#cb309-6" aria-hidden="true" tabindex="-1"></a><span class="co"># define constraints for spectra</span></span>
<span id="cb309-7"><a href="mcr--als.html#cb309-7" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb309-8"><a href="mcr--als.html#cb309-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;angle&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">weight =</span> <span class="fl">0.05</span>)),</span>
<span id="cb309-9"><a href="mcr--als.html#cb309-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">constraint</span>(<span class="st">&quot;norm&quot;</span>, <span class="at">params =</span> <span class="fu">list</span>(<span class="at">type =</span> <span class="st">&quot;length&quot;</span>))</span>
<span id="cb309-10"><a href="mcr--als.html#cb309-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb309-11"><a href="mcr--als.html#cb309-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-12"><a href="mcr--als.html#cb309-12" aria-hidden="true" tabindex="-1"></a><span class="co"># run MCR-ALS with the constraints</span></span>
<span id="cb309-13"><a href="mcr--als.html#cb309-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6</span>)</span>
<span id="cb309-14"><a href="mcr--als.html#cb309-14" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">spec.constraints =</span> sc, <span class="at">cont.constraints =</span> cc)</span>
<span id="cb309-15"><a href="mcr--als.html#cb309-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb309-16"><a href="mcr--als.html#cb309-16" aria-hidden="true" tabindex="-1"></a><span class="co"># show summary</span></span>
<span id="cb309-17"><a href="mcr--als.html#cb309-17" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m)</span></code></pre></div>
<pre><code>## 
## Summary for MCR ALS case (class mcrals)
## 
## Constraints for spectra:
##  -  angle
##  -  norm
## 
## Constraints for contributions:
##  -  norm
## 
##        Expvar Cumexpvar
## Comp 1  62.64     62.64
## Comp 2  22.73     85.37
## Comp 3  14.19     99.56</code></pre>
<div class="sourceCode" id="cb311"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb311-1"><a href="mcr--als.html#cb311-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make variance plots</span></span>
<span id="cb311-2"><a href="mcr--als.html#cb311-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb311-3"><a href="mcr--als.html#cb311-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plotVariance</span>(m)</span>
<span id="cb311-4"><a href="mcr--als.html#cb311-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plotCumVariance</span>(m)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-209-1.png" width="864" /></p>
<p>Since MCR-ALS is iterative algorithm, it should stop when convergence criteria is met. There are two ways to stop MCR-ALS iterations in <em>mdatools</em>. First is a tolerance (<code>tol</code>) parameter, which tells a minimum difference in explained variance to make the algorithm continue. For example, if explained variance on previous step is 0.95467 and on the current step it is 0.95468, the difference is 0.00001 and the algorithm will continue if the tolerance is smaller than this value.</p>
<p>Another way to limit the iterations is to define the maximum number by using parameter <code>max.iter</code>. By default is is set to 100. The <code>mcrals()</code> has a verbose mode which shows improvements in each iteration as it is demonstrated in the example below (we use the same constraint as in the previous chunk of code)</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="mcr--als.html#cb312-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">=</span> <span class="fu">mcrals</span>(carbs<span class="sc">$</span>D, <span class="at">ncomp =</span> <span class="dv">3</span>, <span class="at">spec.constraints =</span> sc, <span class="at">cont.constraints =</span> cc, <span class="at">verbose =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<pre><code>## 
## Starting iterations (max.niter = 100):
## Iteration    1, R2 = 0.000000
## Iteration    2, R2 = 0.957402
## Iteration    3, R2 = 0.976722
## Iteration    4, R2 = 0.987305
## Iteration    5, R2 = 0.992613
## Iteration    6, R2 = 0.994525
## Iteration    7, R2 = 0.995165
## Iteration    8, R2 = 0.995385
## Iteration    9, R2 = 0.995449
## Iteration   10, R2 = 0.995453
## No more improvements.</code></pre>

</div>
</div>
<!-- </div> -->
            </section>

          </div>
        </div>
      </div>
<a href="mcr--purity.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
